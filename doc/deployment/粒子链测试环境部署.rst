
======================
粒子链测试环境部署
======================

--------------
服务器资源配置
--------------

1.应用系统基本信息
~~~~~~~~~~~~~~~~~~

+--------------+---------+----+------------+------------+---------+-------+------+-------+
|Application   | Version |Port|External IP |Internal IP | System  |  CPU  |Memory|Hardisk|
+--------------+---------+----+------------+------------+---------+-------+------+-------+
|Nginx,RocketMQ| 1.12.0  |5432|172.19.6.218|172.19.6.218| CentOS7 | 4cell |  8G  |128G   |
+--------------+---------+----+------------+------------+---------+-------+------+-------+
|Postgresql    |9.4.3.1  |    |172.19.6.217|172.19.6.217| CentOS7 | 4cell |  8G  |128G   |
+--------------+---------+----+------------+------------+---------+-------+------+-------+
| NULL         |         |    |172.19.6.216|172.19.6.216| CentOS7 | 4cell |  8G  |128G   |
+--------------+---------+----+------------+------------+---------+-------+------+-------+
| zk           | 1.12.0  |    |172.19.6.215|172.19.6.215| CentOS7 | 4cell |  8G  |128G   |
+--------------+---------+----+            +            +         +       +      +       +
|tomcat        | 8.0.44  |    |            |            |         |       |      |       |
+--------------+---------+----+            +            +         +       +      +       +
|redis         | 3.2.8   |6379|            |            |         |       |      |       |
+--------------+---------+----+------------+------------+---------+-------+------+-------+


2. 网络配置
------------

2.1. 申请域名列表
~~~~~~~~~~~~~~~~~~

+----------------------+--------------+---------+---------------+-------+
|        域名          |     IP       | 端口号  |   备注        |root   |
+----------------------+--------------+---------+---------------+-------+
| *mall.xt.weilian.cn* | 172.19.6.218 | CentOS7 | Win,Mac,Linux |xtcAuto|
+----------------------+--------------+---------+---------------+-------+
| *mall.xt.weilian.cn* | 172.19.6.217 | CentOS7 | Win,Mac,Linux |xtcAuto|
+----------------------+--------------+---------+---------------+-------+
| *mall.xt.weilian.cn* | 172.19.6.216 | CentOS7 | Win,Mac,Linux |xtcAuto|
+----------------------+--------------+---------+---------------+-------+
| *mall.xt.weilian.cn* | 172.19.6.215 | CentOS7 | Win,Mac,Linux |xtcAuto|
+----------------------+--------------+---------+---------------+-------+

3. 应用安装
------------

**从存储服务器 ftp://tester@172.19.7.109/tools/ 密码 autotester 获取应用安装包。**

* 以下都是以 CentOS 7,JDK 1.8 为基础环境下的通用安装，没有区分具体的应用服务器；
* 请根据规划选择要安装的服务器

3.1. JDK 安装配置
~~~~~~~~~~~~~~~~~~

.. code-block:: bash
    :linenos:

    #在服务器端可以通过 ftp get ,在终端设备可以使用 psftp get/put 上传应用包
    yum install -y jdk-8u144-linux-x64.rpm
    #配置环境变量 JAVA_HOME 和 PATH
    sudo vim ~/.bash_profile
    #编辑配置文件
    PATH=$PATH:$HOME/.local/bin:$HOME/bin
    export JAVA_HOME=/usr/java/jdk1.8.0_144/
    export JRE_HOME=/usr/java/jdk1.8.0_144/jre
    PATH=$PATH:$HOME/bin/$JAVA_HOME/bin:/usr/local/bin/jmeter/bin/
    export PATH
    #保存并退出
    :wq
    #应用配置
    source ~/.bash_profile

    #在普通用户 shell下验证配置
    $ echo $JRE_HOME /usr/java/jdk1.8.0_144/jre
    $ echo $JAVA_HOME /usr/java/jdk1.8.0_144/

3.2. redis 安装配置
~~~~~~~~~~~~~~~~~~~~

*源码安装 redis 服务,优先查看 README.md ,了解具体安装方法*

.. code-block:: bash
    :linenos:

    #从存储服务器下载 redis 安装包
    ftp 172.19.7.109
    testesr
    autotester
    cd lzl_deployment
    get redis-3.2.11.tar.gz
    #在当前登陆用户目录下，解压并编译安装 redis
    sudo yum install -y gcc make tcl
    sudo tar -zxvf redis-3.2.11.tar.gz
    cd redis-3.2.11
    cd deps
    sudo make hiredis lua jemalloc linenoise
    sudo make geohash-int
    cd ../
    #登陆 root 执行安装
    su root
    #root密码：11111111
    sudo make MALLOC=libc && make PREFIX=/usr/local/redis-3.2.11 install
    exit
    sudo make install
    sudo make test

    #创建 usr/local/bin 内的链接后，指定 redis.conf 启用 redis 服务
    sudo ln -s /usr/local/redis-3.2.11 /usr/local/redis
    sudo cp ./redis.conf /usr/local/redis/
    sudo /usr/local/redis/bin/redis-server /usr/local/redis/redis.conf

3.2. tomcat 安装配置
~~~~~~~~~~~~~~~~~~~~

*解压 tomcat 源码包，然后将解压后的源码包复制到 usr/local下,执行bin/startup.sh*

.. code-block:: bash
    :linenos:

    #在安装包所在的路径下解压源码包，创建 usr/bin/ 内的链接后，执行 startup.sh
    tar -zxvf apache-tomcat-8.0.47.tar.gz
    sudo mv apache-tomcat-8.0.47 /usr/local/
    sudo ln -s /usr/local/apache-tomcat-8.0.47 /usr/local/tomcat
    sudo /usr/local/tomcat/bin/startup.sh

3.3. nginx 安装配置
~~~~~~~~~~~~~~~~~~~~
    * 通过源码安装指定版本的Nginx
    * 优先查看 http://nginx.org/en/linux_packages.html 安装说明

.. code-block:: bash
    :linenos:

    #首先更新软件源，安装必需的编译工具包
    sudo yum update -y
    sudo yum install -y gcc make tcl
    sudo yum install -y epel-release

    sudo ./configure --prefix=/usr/local/nginx-1.12.0 \
                     --with-http_stub_status_module \
                     --with-http_ssl_module \
                     --with-http_gzip_static_module
    #该步需要登陆 root 用户执行
    make && make install

    #配置防火墙规则
    sudo firewall-cmd --permanent --zone=public --add-service=http
    sudo firewall-cmd --permanent --zone=public --add-service=https
    sudo firewall-cmd --reload
    #如果没有安装 firewalld，安装并启用即可
    sudo yum install -y firewall
    sudo systemctl start firewall
    sudo systemctl enable firewall

    #启用 Nginx
    sudo systemctl start nginx
    sudo systemctl enable nginx

3.4. 安装  zookeeper
~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: bash
    :linenos:

    tar -zxvf zookeeper-3.4.8.tar.gz -C /usr/local/
    ln -s /usr/local/zookeeper-3.4.8 /usr/local/zookeeper
    sudo cp /usr/local/zookeeper/conf/zoo_sample.cfg /usr/local/zookeeper/zoo.cfg
    sed -i 's/^clientPort*/clientPort=12233/g' /usr/local/zookeeper/zoo.cfg
    #启用服务
    sudo /usr/local/zookeeper/bin/zkServer.sh start

3.5. 安装 apache-rocketmq
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* 推荐方法 http://rocketmq.apache.org/docs/quick-start/

.. code-block:: bash
    :linenos:

    #安装所需工具包
    sudo yum install -y git maven
    #Clone 和编译软件包
    git clone -b develop https://github.com/apache/rocketmq.git
    cd rocketmq
    #如果该步出现下载失败，可以将源码包下载下来再安装
    #http://rocketmq.apache.org/dowloading/releases/
    sudo mvn -Prelease-all -DskipTests clean install -U
    #启用服务
    sudo nohup sh bin/mqnamesrv &
    > sudo nohup sh bin/mqnamesrv &
    > sudo tail -f ~/logs/rocketmqlogs/namesrv.log
    The Name Server boot success...
    #启用Broker
    > sudo nohup sh bin/mqbroker -n localhost:9876 &
    > sudo tail -f ~/logs/rocketmqlogs/broker.log
    The broker[%s, 172.30.30.233:10911] boot success...

3.6. 安装 Postgre
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* 选择要求的版本和系统，按照该页面的方法安装 https://www.postgresql.org/download/linux/redhat/

.. code-block:: bash
    :linenos:

    #安装软件源
    sudo yum install -y https://download.postgresql.org/pub/repos/yum/9.4/redhat/rhel-7-x86_64/pgdg-redhat94-9.4-2.noarch.rpm
    #安装客户端
    sudo yum install -y postgresql94
    #安装服务端, （可选）
    sudo yum install -y postgresql94-server
    #初始化数据库，并允许开机自启
    sudo /usr/pgsql-9.4/bin/postgresql94-setup initdb
    sudo systemctl enable postgresql-9.4
    sudo systemctl start postgresql-9.4


--------------
同步数据库
--------------
